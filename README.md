# Perma-Recall Link

Chrome拡張機能：90日制限を超えて永続的に訪問履歴を保存し、訪問済みリンクを視覚的にマークします。

<img src="assets/icon.png" width="555" />

## 機能概要

- **永続的な履歴保存**: Chromeの標準90日制限を超えて、IndexedDBに訪問履歴を保存
- **リアルタイム更新**: 新しく訪問したページを自動的に記録
- **カスタマイズ可能なスタイリング**: 訪問済みリンクのスタイルをポップアップUIから自由にカスタマイズ可能
- **多言語対応**: 日本語・英語に対応（ブラウザ言語に応じて自動切替）
- **設定画面**: 履歴の再インポート、クリア、統計情報表示、CSS設定機能
- **エクスポート・インポート**: TSV形式で履歴データのバックアップ・復元が可能
- **高速パフォーマンス**: キャッシング機構により、リンクチェックを効率化

## インストール方法

1. このリポジトリをクローンまたはダウンロード
2. Chromeで `chrome://extensions/` を開く
3. 右上の「デベロッパーモード」を有効化
4. 「パッケージ化されていない拡張機能を読み込む」をクリック
5. このプロジェクトの `src` フォルダを選択

## 使用方法

拡張機能をインストールすると、自動的に以下の処理が実行されます：

1. **初回起動時**: 過去90日分の訪問履歴を一括でIndexedDBにインポート
2. **通常使用時**: 新しく訪問したページを自動的に記録
3. **ページ閲覧時**: ページ内のすべてのリンクをチェックし、訪問済みリンクに `extension-perma-recalled` クラスを付与

## 技術仕様

### ファイル構成

```
src/
├── manifest.json           # ManifestV3準拠の拡張機能設定
├── background.js           # IndexedDB管理と履歴同期を行うサービスワーカー
├── content.js              # DOM操作とリンクチェックを行うコンテンツスクリプト
├── styles.css              # 訪問済みリンクのスタイル定義
├── popup.html              # 設定画面UI
├── popup.js                # 設定画面のロジック（統計情報、履歴管理、CSS設定、エクスポート・インポート）
├── popup.css               # 設定画面のスタイル
└── _locales/
    ├── ja/
    │   └── messages.json   # 日本語メッセージ
    └── en/
        └── messages.json   # 英語メッセージ
```

### IndexedDB構造

- **データベース名**: `PermaRecallDB`
- **オブジェクトストア名**: `VisitedLinks`
- **キーパス**: `url`
- **インデックス**: `url` (ユニーク)

### パフォーマンス最適化

- URLチェック結果のメモリキャッシング
- 重複リクエストの防止機構
- バッチ処理による効率的なDB操作
- Mutation Observerによる動的コンテンツ対応

## カスタマイズ

### スタイルの変更

拡張機能のポップアップ（ツールバーアイコンをクリック）から、訪問済みリンクのスタイルをカスタマイズできます：

1. ツールバーの拡張機能アイコンをクリック
2. 「スタイル設定」セクションのテキストエリアにカスタムCSSを入力
3. リアルタイムプレビューで確認しながら編集
4. 「保存」ボタンをクリック

**デフォルトスタイルの例**:
```css
a.extension-perma-recalled {
  border: 2px solid #0088AA !important;
  border-radius: 3px !important;
  padding: 2px 4px !important;
  background-color: rgba(0, 136, 170, 0.05) !important;
}
```

**注意**: CSSを空白で保存すると、訪問済みリンクにスタイルが適用されなくなります。これは他のCSS拡張機能と組み合わせて使用する場合に便利です。

### URL正規化

開発者向け: `content.js` の `normalizeUrl()` 関数を編集することで、URLの正規化ルールをカスタマイズできます。

## 注意事項

- この拡張機能は訪問履歴をローカル（IndexedDB）に保存します
- データは他のデバイスと同期されません
- 大量の履歴データがある場合、初回インポートに時間がかかる場合があります

## ライセンス

MIT License

## 開発者向け情報

### デバッグ

- バックグラウンドログ: `chrome://extensions/` → 拡張機能の「サービスワーカー」をクリック
- コンテンツスクリプトログ: ページ上で右クリック → 「検証」→ Consoleタブ

### 実装済み機能

- ✅ 統計情報の表示（保存URL数、最終インポート日時）
- ✅ 設定画面（ポップアップUI）
- ✅ 多言語対応（日本語・英語）
- ✅ カスタムCSSによるスタイル設定
- ✅ 手動での履歴再インポート・クリア機能
- ✅ TSV形式での履歴データのエクスポート・インポート

## データのバックアップ・復元

### エクスポート（バックアップ）

1. 拡張機能のポップアップを開く
2. 「エクスポート・インポート」セクションの「TSVにエクスポート」をクリック
3. `perma-recall-history-YYYY-MM-DD.tsv` ファイルがダウンロードされます

### インポート（復元）

1. 拡張機能のポップアップを開く
2. 「エクスポート・インポート」セクションの「TSVからインポート」をクリック
3. エクスポートしたTSVファイルを選択
4. インポートが完了すると、件数とエラー数が表示されます

**TSVファイル形式**:
```tsv
url	timestamp
https://example.com	1704614400000
https://example.org	1704700800000
```
- 1行目: ヘッダー（`url` と `timestamp`）
- 2行目以降: URLとタイムスタンプ（タブ区切り）
- タイムスタンプはミリ秒単位のUnixタイムスタンプ

### 今後の拡張案

- URL正規化の高度化（クエリパラメータの除去など）
- 統計情報の拡張（訪問回数、最終訪問日時など）
- ドメインフィルタリング機能